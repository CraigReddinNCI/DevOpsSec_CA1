#!/bin/bash
set -e

echo "Starting docker-entrypoint script..."

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    JEMALLOC_LIB=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    if [ -n "$JEMALLOC_LIB" ]; then
        export LD_PRELOAD="$JEMALLOC_LIB"
        echo "Enabled jemalloc: $JEMALLOC_LIB"
    else
        echo "Warning: jemalloc library not found, proceeding without it."
    fi
fi

# Remove pre-existing server.pid to prevent conflicts
PID_FILE="/rails/tmp/pids/server.pid"
if [ -f "$PID_FILE" ]; then
    echo "Removing stale server.pid file..."
    rm -f "$PID_FILE"
fi

# If running the Rails server, prepare the database
if [[ "${@: -2:1}" == "./bin/rails" && "${@: -1:1}" == "server" ]]; then
    echo "Preparing database..."
    ./bin/rails db:prepare
fi

echo "Executing command: $@"
exec "$@"
